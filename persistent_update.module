<?php

/**
 * @file
 * Core functions for the Persistent Update API module.
 */

/**
 * Implements hook_batch_alter().
 */
function persistent_update_batch_alter(&$batch) {
  $update_finish_callbacks = [
    'drush_update_finished',
    ['\Drupal\system\Controller\DbUpdateController', 'batchFinished'],
  ];
  foreach ($batch['sets'] as $set_id => $set) {
    // If batch is generated by 'drush updb' or update.php, ensure that the
    // Persistent Update hooks are always run.
    if (isset($set['finished']) && in_array($set['finished'], $update_finish_callbacks)) {
      foreach ($set['operations'] as $operation_id => $operation) {
        if ($operation[1][0] == 'persistent_update' && $operation[1][1] == 8101) {
          $batch['sets'][$set_id]['operations'][$operation_id][0] = 'persistent_update_run';
        }
      }
    }
  }
}

/**
 * Persistent Update API update callback.
 */
function persistent_update_run() {
  // Invoke hook_persistent_update().
  \Drupal::moduleHandler()->invokeAll('persistent_update');

  // Set the schema back before the current Persistent Updates update hook.
  drupal_set_installed_schema_version('persistent_update', 8100);
}
